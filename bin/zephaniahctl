#!/usr/bin/env bash
set -euo pipefail

# Zephaniah Control Script
# Public document search and archival tool

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
PID_DIR="$ROOT_DIR/.pids"
LOG_DIR="$ROOT_DIR/.logs"

FLUTTER_APP_NAME="zephaniah"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

mkdir -p "$PID_DIR" "$LOG_DIR"

print_banner() {
    echo -e "${CYAN}"
    echo "╔═══════════════════════════════════════════════════════╗"
    echo "║                     ZEPHANIAH                         ║"
    echo "║      Public Document Search & Archival Tool           ║"
    echo "╚═══════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

print_status() {
    local name="$1"
    local pid_file="$PID_DIR/$2.pid"

    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
            echo -e "${GREEN}●${NC} $name: ${GREEN}RUNNING${NC} [PID: $pid]"
            return 0
        fi
    fi

    # Check for running app by name
    local app_pid=$(pgrep -f "$FLUTTER_APP_NAME.app/Contents/MacOS" 2>/dev/null | head -1 || true)
    if [ -n "$app_pid" ]; then
        echo -e "${GREEN}●${NC} $name: ${GREEN}RUNNING${NC} [PID: $app_pid]"
        return 0
    fi

    echo -e "${RED}○${NC} $name: ${RED}STOPPED${NC}"
    return 1
}

ensure_deps() {
    echo -e "${BLUE}Checking dependencies...${NC}"
    cd "$ROOT_DIR"

    if ! flutter pub get > "$LOG_DIR/pub_get.log" 2>&1; then
        echo -e "${RED}Failed to get dependencies. Check $LOG_DIR/pub_get.log${NC}"
        return 1
    fi
    echo -e "${GREEN}Dependencies OK${NC}"
}

build_flutter() {
    local target="${1:-macos}"

    echo -e "${BLUE}Building Flutter app ($target)...${NC}"
    cd "$ROOT_DIR"

    case "$target" in
        macos)
            flutter build macos --release > "$LOG_DIR/build.log" 2>&1
            ;;
        linux)
            flutter build linux --release > "$LOG_DIR/build.log" 2>&1
            ;;
        windows)
            flutter build windows --release > "$LOG_DIR/build.log" 2>&1
            ;;
        *)
            echo -e "${RED}Unknown target: $target${NC}"
            return 1
            ;;
    esac

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Build complete${NC}"
    else
        echo -e "${RED}Build failed. Check $LOG_DIR/build.log${NC}"
        return 1
    fi
}

start_flutter() {
    local mode="${1:-release}"
    local target="${2:-macos}"

    echo -e "${BLUE}Starting Zephaniah ($target, $mode mode)...${NC}"
    cd "$ROOT_DIR"

    # Kill any existing instance
    stop_flutter 2>/dev/null || true

    if [ "$mode" = "dev" ]; then
        flutter run -d "$target" > "$LOG_DIR/flutter.log" 2>&1 &
        echo $! > "$PID_DIR/flutter.pid"
        echo -e "${GREEN}Started in dev mode. Logs: $LOG_DIR/flutter.log${NC}"
    else
        # Build first
        build_flutter "$target"

        case "$target" in
            macos)
                local app_path="$ROOT_DIR/build/macos/Build/Products/Release/$FLUTTER_APP_NAME.app"
                if [ -d "$app_path" ]; then
                    open "$app_path"
                    echo -e "${GREEN}Zephaniah launched${NC}"
                else
                    echo -e "${RED}App not found at $app_path${NC}"
                    return 1
                fi
                ;;
            linux)
                local app_path="$ROOT_DIR/build/linux/x64/release/bundle/$FLUTTER_APP_NAME"
                if [ -f "$app_path" ]; then
                    "$app_path" > "$LOG_DIR/flutter.log" 2>&1 &
                    echo $! > "$PID_DIR/flutter.pid"
                    echo -e "${GREEN}Zephaniah launched${NC}"
                else
                    echo -e "${RED}App not found at $app_path${NC}"
                    return 1
                fi
                ;;
            *)
                echo -e "${YELLOW}Manual launch required for $target${NC}"
                ;;
        esac
    fi
}

stop_flutter() {
    echo -e "${BLUE}Stopping Zephaniah...${NC}"

    # Kill by PID file
    if [ -f "$PID_DIR/flutter.pid" ]; then
        local pid=$(cat "$PID_DIR/flutter.pid")
        kill "$pid" 2>/dev/null || true
        rm -f "$PID_DIR/flutter.pid"
    fi

    # Kill macOS app
    osascript -e "quit app \"$FLUTTER_APP_NAME\"" 2>/dev/null || true

    # Kill any remaining processes
    pkill -f "$FLUTTER_APP_NAME.app/Contents/MacOS" 2>/dev/null || true

    echo -e "${GREEN}Zephaniah stopped${NC}"
}

cmd_up() {
    local mode="release"
    local target="macos"

    while [[ $# -gt 0 ]]; do
        case $1 in
            --dev) mode="dev" ;;
            --release) mode="release" ;;
            --macos) target="macos" ;;
            --linux) target="linux" ;;
            --windows) target="windows" ;;
            *) echo "Unknown option: $1" ;;
        esac
        shift
    done

    print_banner
    ensure_deps
    start_flutter "$mode" "$target"

    echo ""
    echo -e "${GREEN}=== Zephaniah Ready ===${NC}"
}

cmd_down() {
    print_banner
    stop_flutter
    echo -e "${GREEN}=== Zephaniah Stopped ===${NC}"
}

cmd_status() {
    print_banner
    echo ""
    print_status "Zephaniah" "flutter"
    echo ""

    # Show storage info
    local docs_dir="$HOME/Documents/Zephaniah"
    if [ -d "$docs_dir" ]; then
        local artifact_count=$(find "$docs_dir/artifacts" -type f 2>/dev/null | wc -l | tr -d ' ')
        local db_size=$(du -sh "$docs_dir/database" 2>/dev/null | cut -f1 || echo "0")
        echo -e "${BLUE}Storage:${NC}"
        echo "  Artifacts: $artifact_count files"
        echo "  Database: $db_size"
        echo "  Location: $docs_dir"
    fi

    echo ""
    echo -e "${BLUE}Commands:${NC}"
    echo "  zephaniahctl up       - Start Zephaniah"
    echo "  zephaniahctl down     - Stop Zephaniah"
    echo "  zephaniahctl logs     - View logs"
}

cmd_restart() {
    cmd_down
    sleep 2
    cmd_up "$@"
}

cmd_logs() {
    local target="${1:-flutter}"
    local log_file="$LOG_DIR/$target.log"

    if [ -f "$log_file" ]; then
        echo "Tailing $log_file (Ctrl+C to exit)..."
        tail -f "$log_file"
    else
        echo "Log file not found: $log_file"
        echo "Available logs:"
        ls -la "$LOG_DIR"/*.log 2>/dev/null || echo "  (none)"
    fi
}

cmd_clean() {
    echo -e "${BLUE}Cleaning temporary files...${NC}"
    rm -rf "$LOG_DIR"/*.log 2>/dev/null || true
    rm -rf "$PID_DIR"/*.pid 2>/dev/null || true
    cd "$ROOT_DIR" && flutter clean > /dev/null 2>&1 || true
    echo -e "${GREEN}Cleaned.${NC}"
}

cmd_test() {
    echo -e "${BLUE}Running tests...${NC}"
    cd "$ROOT_DIR"
    flutter test
}

usage() {
    print_banner
    cat << EOF
${GREEN}Usage:${NC} zephaniahctl <command> [options]

${GREEN}Service Commands:${NC}
    up [options]            Start Zephaniah
        --dev               Run in development mode
        --release           Run in release mode (default)
        --macos             Target macOS (default)
        --linux             Target Linux
        --windows           Target Windows
    down                    Stop Zephaniah
    restart                 Restart Zephaniah
    status                  Show status

${GREEN}Development Commands:${NC}
    build [target]          Build app (macos|linux|windows)
    test                    Run tests
    clean                   Clean build artifacts

${GREEN}Utility Commands:${NC}
    logs [target]           Tail logs (flutter|build|all)
    version                 Show version info
    help                    Show this help

${GREEN}Examples:${NC}
    zephaniahctl up
    zephaniahctl up --dev
    zephaniahctl status
    zephaniahctl logs

EOF
}

case "${1:-}" in
    up) shift; cmd_up "$@" ;;
    down) cmd_down ;;
    restart) shift; cmd_restart "$@" ;;
    status) cmd_status ;;
    build)
        shift
        ensure_deps
        build_flutter "${1:-macos}"
        ;;
    test) cmd_test ;;
    clean) cmd_clean ;;
    logs) shift; cmd_logs "${1:-flutter}" ;;
    version)
        print_banner
        echo "Root: $ROOT_DIR"
        command -v flutter >/dev/null && echo "Flutter: $(flutter --version 2>&1 | head -1)"
        command -v dart >/dev/null && echo "Dart: $(dart --version 2>&1)"
        ;;
    help|-h|--help) usage ;;
    *) usage ;;
esac
